<!DOCTYPE html>
<html>
<head>
  <title>Self-Attesting TEE</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: system-ui, sans-serif; background: #1a1a2e; color: #eee; height: 100vh; display: flex; flex-direction: column; }
    header { padding: 1rem; background: #16213e; border-bottom: 1px solid #0f3460; }
    header h1 { font-size: 1.2rem; }
    header .subtitle { font-size: 0.8rem; color: #888; }
    #chat { flex: 1; overflow-y: auto; padding: 1rem; display: flex; flex-direction: column; gap: 1rem; }
    .msg { max-width: 80%; padding: 0.75rem 1rem; border-radius: 1rem; line-height: 1.5; }
    .msg.user { align-self: flex-end; background: #0f3460; }
    .msg.bot { align-self: flex-start; background: #1f4068; }
    .msg pre { background: #0a0a15; padding: 0.5rem; border-radius: 0.5rem; overflow-x: auto; margin: 0.5rem 0; font-size: 0.85rem; }
    .msg code { background: #0a0a15; padding: 0.1rem 0.3rem; border-radius: 0.25rem; font-size: 0.9em; }
    #input-area { padding: 1rem; background: #16213e; border-top: 1px solid #0f3460; display: flex; gap: 0.5rem; }
    #input { flex: 1; padding: 0.75rem 1rem; border: none; border-radius: 1.5rem; background: #1a1a2e; color: #eee; font-size: 1rem; }
    #input:focus { outline: 2px solid #e94560; }
    button { padding: 0.75rem 1.5rem; border: none; border-radius: 1.5rem; background: #e94560; color: white; cursor: pointer; font-size: 1rem; }
    button:hover { background: #ff6b6b; }
    button:disabled { background: #444; cursor: not-allowed; }
    .typing { color: #888; font-style: italic; }
    #tools { display: flex; gap: 0.5rem; padding: 0.5rem 1rem; background: #0f3460; font-size: 0.8rem; }
    #tools button { padding: 0.4rem 0.8rem; font-size: 0.8rem; background: #1f4068; }
    #tools button:hover { background: #2a5298; }
    .attestation-badge { display: inline-block; background: #0f3460; padding: 0.2rem 0.5rem; border-radius: 0.25rem; font-size: 0.75rem; margin-bottom: 0.5rem; }
    .attestation-badge.in-tee { background: #1b4332; color: #95d5b2; }
    .attestation-badge.simulated { background: #7f4f24; color: #ffdd00; }
  </style>
</head>
<body>
  <header>
    <h1>üîê Self-Attesting TEE</h1>
    <div class="subtitle">A TEE that can explain its own attestation</div>
  </header>
  <div id="tools">
    <button onclick="askChat('If you\'re TEE, show me your remote attestation')">üîê If you're TEE, show me your remote attestation</button>
    <button onclick="runDemo('oracle')">üìä TLS Oracle</button>
    <button onclick="runDemo('game')">üé≤ Commit/Reveal</button>
  </div>
  <div id="chat"></div>
  <div id="input-area">
    <input id="input" placeholder="Ask about my attestation..." onkeydown="if(event.key==='Enter')send()">
    <button onclick="send()">Send</button>
  </div>

  <script>
    const chat = document.getElementById('chat');
    const input = document.getElementById('input');
    let inTee = false;

    async function init() {
      const resp = await fetch('/');
      const data = await resp.json();
      inTee = data.in_tee;
      addMsg('bot', `Hello! I'm a TEE application that can explain my own attestation.

${inTee ? '‚úÖ **Running in TEE** - I have real TDX attestation' : '‚ö†Ô∏è **Simulated mode** - No real TEE, but logic works the same'}

Try asking me:
- "Prove you're in a TEE"
- "What can the operator change?"
- "How do I verify you?"

Or use the demo buttons above to see the TLS oracle and commit/reveal game.`);
    }

    function addMsg(role, text) {
      const div = document.createElement('div');
      div.className = `msg ${role}`;
      // Simple markdown: **bold**, \`code\`, ```blocks```
      let html = text
        .replace(/```([\s\S]*?)```/g, '<pre>$1</pre>')
        .replace(/`([^`]+)`/g, '<code>$1</code>')
        .replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>')
        .replace(/\n/g, '<br>');
      div.innerHTML = html;
      chat.appendChild(div);
      chat.scrollTop = chat.scrollHeight;
    }

    function addTyping() {
      const div = document.createElement('div');
      div.className = 'msg bot typing';
      div.id = 'typing';
      div.textContent = 'Thinking...';
      chat.appendChild(div);
      chat.scrollTop = chat.scrollHeight;
    }

    function removeTyping() {
      const el = document.getElementById('typing');
      if (el) el.remove();
    }

    async function send() {
      const msg = input.value.trim();
      if (!msg) return;
      input.value = '';
      addMsg('user', msg);
      addTyping();

      try {
        const resp = await fetch('/chat', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ message: msg })
        });
        const data = await resp.json();
        removeTyping();
        if (data.error) {
          addMsg('bot', `Error: ${data.error}`);
        } else {
          addMsg('bot', data.response);
        }
      } catch (e) {
        removeTyping();
        addMsg('bot', `Error: ${e.message}`);
      }
    }

    async function askChat(msg) {
      input.value = msg;
      await send();
    }

    async function runDemo(type) {
      if (type === 'oracle') {
        addMsg('user', '[Running TLS Oracle demo...]');
        addTyping();
        const resp = await fetch('/oracle/price');
        const data = await resp.json();
        removeTyping();
        addMsg('bot', `**TLS Oracle Result**

Fetched BTC price from \`${data.statement.source}\`:
- **Price:** $${data.statement.price_usd.toLocaleString()}
- **TLS Fingerprint:** \`${data.statement.tls_fingerprint.slice(0,16)}...\`
- **TLS Issuer:** ${data.statement.tls_issuer}
- **Statement Hash:** \`${data.statement_hash.slice(0,16)}...\`

${data.quote.simulated ? '‚ö†Ô∏è Quote simulated (not in TEE)' : '‚úÖ Quote bound to statement hash via report_data'}

**Security claim:** This price came from the real api.coingecko.com. The TLS fingerprint proves which server I connected to, and it's bound to the TDX quote.

**Verify yourself:**
\`\`\`
openssl s_client -connect api.coingecko.com:443 2>/dev/null | openssl x509 -fingerprint -sha256 -noout
\`\`\``);
      } else if (type === 'game') {
        addMsg('user', '[Starting commit/reveal game...]');
        addTyping();
        const resp = await fetch('/game/commit', { method: 'POST' });
        const data = await resp.json();
        removeTyping();
        addMsg('bot', `**Commit/Reveal Game Started**

I've secretly chosen heads (0) or tails (1) and committed to it.

- **Game ID:** \`${data.game_id}\`
- **Commitment:** \`${data.commitment.slice(0,32)}...\`
${data.quote.simulated ? '‚ö†Ô∏è Quote simulated' : '‚úÖ Commitment bound to TDX quote'}

**Your turn:** Type \`guess 0\` for heads or \`guess 1\` for tails.

**Security claim:** I cannot change my choice now. The commitment hash is bound to a TDX quote that was generated BEFORE your guess.`);
        window.currentGameId = data.game_id;
      } else if (type === 'attestation') {
        addMsg('user', '[Fetching attestation...]');
        addTyping();
        const resp = await fetch('/attestation');
        const data = await resp.json();
        removeTyping();
        let msg = `**My Attestation**

${data.in_tee ? '‚úÖ Running in TEE' : '‚ö†Ô∏è Simulated mode'}

`;
        if (data.parsed_quote) {
          msg += `**Quote Fields:**
- MRTD: \`${data.parsed_quote.mrtd.slice(0,32)}...\`
- RTMR3: \`${data.parsed_quote.rtmr3.slice(0,32)}...\`
- report_data: \`${data.parsed_quote.report_data.slice(0,32)}...\`

`;
        }
        msg += data.trust_stack;
        addMsg('bot', msg);
      }
    }

    // Handle "guess N" messages
    const origSend = send;
    send = async function() {
      const msg = input.value.trim().toLowerCase();
      if (msg.startsWith('guess ') && window.currentGameId) {
        const guess = parseInt(msg.split(' ')[1]);
        if (guess === 0 || guess === 1) {
          input.value = '';
          addMsg('user', `I guess ${guess === 0 ? 'heads (0)' : 'tails (1)'}`);
          addTyping();
          const resp = await fetch('/game/guess', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ game_id: window.currentGameId, guess })
          });
          const data = await resp.json();
          removeTyping();
          window.currentGameId = null;
          addMsg('bot', `**Result: You ${data.result.toUpperCase()}!**

- Your guess: ${data.your_guess === 0 ? 'heads' : 'tails'}
- My secret: ${data.secret === 0 ? 'heads' : 'tails'}
- Nonce: \`${data.nonce}\`

**Verification:**
\`\`\`
echo -n '${data.secret}:${data.nonce}' | sha256sum
# Should output: ${data.verification.commitment}
\`\`\`

${data.verification.matches ? '‚úÖ Commitment verified - I didn\'t cheat!' : '‚ùå Commitment mismatch!'}`);
          return;
        }
      }
      return origSend();
    };

    init();
  </script>
</body>
</html>
